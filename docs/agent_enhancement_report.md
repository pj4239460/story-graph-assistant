# Agent å¢å¼ºå®ŒæˆæŠ¥å‘Š

## âœ… å·²å®ç°çš„ä¸‰å¤§æ”¹è¿›

### 1. RAG å·¥å…· - `search_story_context`

**ä½ç½®:** [langgraph_agent_service.py#L69-L92](../src/services/langgraph_agent_service.py)

**åŠŸèƒ½:**
- è¯­ä¹‰æœç´¢æ•´ä¸ªæ•…äº‹æ•°æ®åº“
- æ•´åˆ FAISS å‘é‡æœç´¢ + å…³é”®è¯æœç´¢
- è¿”å›æ ¼å¼åŒ–çš„ç›¸å…³è§’è‰²å’Œåœºæ™¯ä¸Šä¸‹æ–‡

**é›†æˆ:**
- ä½¿ç”¨ç°æœ‰çš„ `SearchService.get_contextual_summary()`
- è‡ªåŠ¨å¤„ç† vector_db ä¸å¯ç”¨çš„æƒ…å†µï¼ˆfallback åˆ°å…³é”®è¯æœç´¢ï¼‰

**ä½¿ç”¨åœºæ™¯:**
```
ç”¨æˆ·: "åœ¨è¿™ä¸ªä¸–ç•Œé‡Œå¸å›½å’Œæ•™ä¼šçš„å…³ç³»æ˜¯æ€æ ·çš„ï¼Ÿ"
Agent: è°ƒç”¨ search_story_context("å¸å›½å’Œæ•™ä¼šçš„å…³ç³»")
      â†“ è¿”å›ç›¸å…³åœºæ™¯å’Œè§’è‰²ä¿¡æ¯
      â†“ Agent ç”¨è‡ªç„¶è¯­è¨€æ€»ç»“å›ç­”
```

---

### 2. åœºæ™¯åˆ†æå·¥å…· - `analyze_scene`

**ä½ç½®:** [langgraph_agent_service.py#L94-L165](../src/services/langgraph_agent_service.py)

**åŠŸèƒ½:**
- æ•´åˆ `AIService` çš„ä¸‰å¤§åˆ†æèƒ½åŠ›ï¼š
  - `summarize_scene()` - AI ç”Ÿæˆæ‘˜è¦
  - `extract_facts()` - æå–è®¾å®šå’Œå‰§æƒ…ç‚¹
  - (é¢„ç•™) OOC æ£€æµ‹
- ä¸€æ¬¡è°ƒç”¨è·å¾—å®Œæ•´çš„åœºæ™¯åˆ†ææŠ¥å‘Š

**è¾“å‡ºæ ¼å¼:**
```markdown
# Scene Analysis: åœºæ™¯æ ‡é¢˜
## ğŸ“ Summary
AI ç”Ÿæˆçš„æ‘˜è¦...

## ğŸŒ Extracted Facts & Plot Points
- [è§’è‰²] è§’è‰²ç›¸å…³ä¿¡æ¯
- [è®¾å®š] ä¸–ç•Œè§‚è®¾å®š
- [ä¼ç¬”] å‰§æƒ…ä¼ç¬”

## ğŸ“Š Scene Metadata
- Choices: X options
- Tags: #æ ‡ç­¾1, #æ ‡ç­¾2
- Characters: è§’è‰²A, è§’è‰²B
```

**ä½¿ç”¨åœºæ™¯:**
```
ç”¨æˆ·: "å¸®æˆ‘åˆ†æä¸€ä¸‹ scene_01"
Agent: è°ƒç”¨ analyze_scene("scene_01")
      â†“ è¿”å›å®Œæ•´åˆ†ææŠ¥å‘Š
      â†“ Agent è§£è¯»å¹¶ç»™å‡ºå»ºè®®
```

---

### 3. æ„å›¾åˆ†ç±» + åŒæ¨¡å¼è·¯ç”±

**ä½ç½®:** [langgraph_agent_service.py#L319-L376](../src/services/langgraph_agent_service.py)

**æ¶æ„:**
```
ç”¨æˆ·è¾“å…¥
  â†“
classify_intent èŠ‚ç‚¹
  â”œâ”€ intent = "qa" â†’ qa_agent_node
  â”‚   â”œâ”€ ç³»ç»Ÿæç¤ºï¼šå¼ºè°ƒä½¿ç”¨å·¥å…·è·å–å‡†ç¡®ä¿¡æ¯
  â”‚   â”œâ”€ ä¼˜å…ˆä½¿ç”¨ search_story_context
  â”‚   â””â”€ ä¸ç¼–é€ ä¿¡æ¯
  â””â”€ intent = "chat" â†’ chat_agent_node
      â”œâ”€ ç³»ç»Ÿæç¤ºï¼šå¼ºè°ƒåˆ›æ„è®¨è®ºå’Œå»ºè®®
      â””â”€ å·¥å…·å¯é€‰ï¼Œé‡ç‚¹æ˜¯å¯¹è¯
```

**åˆ†ç±»é€»è¾‘:**
- **QA æ¨¡å¼:** äº‹å®æ€§é—®é¢˜ï¼ˆ"æœ‰å‡ ä¸ªè§’è‰²ï¼Ÿ"ï¼Œ"é™ˆå¢¨æ˜¯è°ï¼Ÿ"ï¼‰
- **Chat æ¨¡å¼:** è®¨è®ºå’Œå»ºè®®ï¼ˆ"è¿™ä¸ªè®¾å®šæ€ä¹ˆæ ·ï¼Ÿ"ï¼Œ"å¦‚ä½•æ”¹è¿›ï¼Ÿ"ï¼‰

**ä¼˜åŠ¿:**
- å‡å°‘å·¥å…·è¯¯ç”¨ï¼ˆChat æ¨¡å¼ä¸ä¼šè¿‡åº¦è°ƒç”¨æŸ¥è¯¢å·¥å…·ï¼‰
- æç¤ºè¯æ›´ä¸“æ³¨ï¼ˆQA å¼ºè°ƒå‡†ç¡®æ€§ï¼ŒChat å¼ºè°ƒåˆ›é€ æ€§ï¼‰
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼ˆä¸åŒåœºæ™¯ä¸åŒé£æ ¼ï¼‰

---

## ğŸ¯ æµ‹è¯•ç”¨ä¾‹

### QA æ¨¡å¼æµ‹è¯•

1. **åŸºç¡€æŸ¥è¯¢:**
   - â“ "ç°åœ¨æ•´ä¸ªæ•…äº‹ä¸­æœ‰å‡ ä¸ªè§’è‰²ï¼Ÿ"
   - âœ… åº”è°ƒç”¨ `get_all_characters()`

2. **è¯­ä¹‰æœç´¢:**
   - â“ "è¿™ä¸ªä¸–ç•Œçš„ç§‘æŠ€æ°´å¹³å¦‚ä½•ï¼Ÿ"
   - âœ… åº”è°ƒç”¨ `search_story_context("ç§‘æŠ€æ°´å¹³")`

3. **åœºæ™¯åˆ†æ:**
   - â“ "åˆ†æä¸€ä¸‹ scene_01"
   - âœ… åº”è°ƒç”¨ `analyze_scene("scene_01")`

4. **è§’è‰²æŸ¥è¯¢:**
   - â“ "é™ˆå¢¨æ˜¯è°ï¼Ÿ"
   - âœ… åº”è°ƒç”¨ `get_character_by_name("é™ˆå¢¨")` æˆ– `search_story_context("é™ˆå¢¨")`

### Chat æ¨¡å¼æµ‹è¯•

1. **åˆ›æ„è®¨è®º:**
   - â“ "æˆ‘è§‰å¾—è¿™ä¸ªè§’è‰²è®¾å®šæ€ä¹ˆæ ·ï¼Ÿ"
   - âœ… åº”ç›´æ¥è®¨è®ºï¼Œä¸è¿‡åº¦è°ƒç”¨å·¥å…·

2. **å»ºè®®å¾è¯¢:**
   - â“ "æ€ä¹ˆè®©å‰§æƒ…æ›´æœ‰å¼ åŠ›ï¼Ÿ"
   - âœ… åº”æä¾›åˆ›æ„å»ºè®®

3. **å¤´è„‘é£æš´:**
   - â“ "å¦‚æœåŠ å…¥æ—¶é—´ç©¿è¶Šå…ƒç´ ä¼šæ€æ ·ï¼Ÿ"
   - âœ… åº”å¼€æ”¾æ€§è®¨è®º

---

## ğŸ“Š å·¥å…·ä¼˜å…ˆçº§

å·¥å…·åˆ—è¡¨é¡ºåºï¼ˆåœ¨ `_create_tools()` ä¸­çš„ä½ç½®ï¼‰ï¼š

1. â­ `search_story_context` - **æœ€é«˜ä¼˜å…ˆçº§**ï¼ˆRAG å·¥å…·ï¼‰
2. â­ `analyze_scene` - åœºæ™¯åˆ†æ
3. `get_all_characters` - åŸºç¡€æŸ¥è¯¢
4. `get_character_by_name` - å…·ä½“è§’è‰²æŸ¥è¯¢
5. `get_all_scenes` - åœºæ™¯åˆ—è¡¨
6. `search_scenes` - å…³é”®è¯æœç´¢
7. `count_endings` - ç»“å±€ç»Ÿè®¡
8. `get_world_facts` - ä¸–ç•Œè§‚è®¾å®š

**æ³¨æ„:** å·¥å…·é¡ºåºä¼šå½±å“ LLM çš„é€‰æ‹©å€¾å‘ï¼ˆè™½ç„¶ä¸ç»å¯¹ï¼‰ï¼Œå°†æœ€é‡è¦çš„å·¥å…·æ”¾åœ¨å‰é¢ã€‚

---

## ğŸš€ æœªæ¥æ‰©å±•æ–¹å‘

### çŸ­æœŸï¼ˆå¯ç«‹å³å®ç°ï¼‰

1. **è§’è‰²è·¯çº¿åˆ†æå·¥å…·**
   ```python
   @tool
   def get_character_routes(name: str) -> str:
       """åˆ†æè§’è‰²çš„å‰§æƒ…çº¿å’Œå‡ºåœºåœºæ™¯"""
   ```

2. **ç»“æ„æ¦‚è§ˆå·¥å…·**
   ```python
   @tool
   def get_structure_overview() -> str:
       """ç»Ÿè®¡å„ç« èŠ‚åœºæ™¯æ•°ã€åˆ†æ”¯æ·±åº¦ç­‰"""
   ```

3. **çº¿ç´¢æ£€æµ‹å·¥å…·**
   ```python
   @tool
   def scan_unresolved_threads() -> str:
       """æŸ¥æ‰¾æœªæ”¶å°¾çš„ä¼ç¬”å’Œçº¿ç´¢"""
   ```

### ä¸­æœŸï¼ˆéœ€è¦æ›´å¤šæ•°æ®æ”¯æŒï¼‰

1. **OOC æ£€æµ‹é›†æˆ**
   - åœ¨ `analyze_scene` ä¸­å®Œæ•´é›†æˆ `AIService.check_ooc()`
   - éœ€è¦å…ˆå®Œå–„ Character æ¨¡å‹çš„æ€§æ ¼æè¿°

2. **åŠ¨æ€å·¥å…·é›†**
   - æ ¹æ®é¡¹ç›®çŠ¶æ€åŠ¨æ€å¯ç”¨/ç¦ç”¨å·¥å…·
   - ä¾‹å¦‚ï¼šåªæœ‰æå–è¿‡ facts åæ‰å¯ç”¨ `get_world_facts`

3. **å¤šæ­¥éª¤å·¥ä½œæµ**
   - ä¾‹å¦‚ï¼š"å…¨é¢åˆ†ææ•…äº‹" = search_context â†’ analyze_scenes â†’ structure_overview
   - ä½¿ç”¨ LangGraph çš„å­å›¾å®ç°

### é•¿æœŸï¼ˆæ¶æ„çº§ï¼‰

1. **å¤š Agent åä½œ**
   - å‰§æƒ…æ€»ç›‘ Agentï¼ˆå®è§‚ç»“æ„ï¼‰
   - è§’è‰²é¡¾é—® Agentï¼ˆè§’è‰²ä¸€è‡´æ€§ï¼‰
   - è®¾å®šç®¡ç† Agentï¼ˆä¸–ç•Œè§‚ç»´æŠ¤ï¼‰

2. **æŒä¹…åŒ–è®°å¿†**
   - ä½¿ç”¨ LangGraph çš„ checkpointer
   - è®°ä½ç”¨æˆ·çš„åˆ›ä½œåå¥½å’Œé£æ ¼

3. **ä¸»åŠ¨å»ºè®®**
   - Agent ä¸»åŠ¨å‘ç°é—®é¢˜ï¼ˆå¦‚è§’è‰²é•¿æ—¶é—´æœªå‡ºåœºï¼‰
   - å®šæœŸç”Ÿæˆ"æ•…äº‹å¥åº·æŠ¥å‘Š"

---

## ğŸ“ ä»£ç å˜æ›´æ€»ç»“

### ä¿®æ”¹æ–‡ä»¶

1. **src/services/langgraph_agent_service.py**
   - âœ… æ·»åŠ  `search_story_context` å·¥å…·
   - âœ… æ·»åŠ  `analyze_scene` å·¥å…·
   - âœ… å®ç°æ„å›¾åˆ†ç±»èŠ‚ç‚¹ `classify_intent`
   - âœ… å®ç°åŒæ¨¡å¼è·¯ç”±ï¼ˆqa_agent + chat_agentï¼‰
   - âœ… æ·»åŠ ä¸“ç”¨ç³»ç»Ÿæç¤ºè¯ï¼ˆ`_get_qa_system_prompt`, `_get_chat_system_prompt`ï¼‰

2. **src/app.py**
   - âœ… æš´éœ² `search_service` åˆ° session_state

3. **src/ui/chat_view.py**
   - âœ… ä¼ é€’ `search_service` å’Œ `ai_service` ç»™ LangGraphAgentService

### æ–°å¢æ–‡ä»¶

- **docs/agent_guide.zh.md** (æ›´æ–°) - åŒ…å«æœ€æ–°æ¶æ„è¯´æ˜
- **docs/agent_guide.en.md** (æ›´æ–°) - è‹±æ–‡ç‰ˆæŒ‡å—
- **docs/agent_enhancement_report.md** (æœ¬æ–‡ä»¶) - å¢å¼ºå®ŒæˆæŠ¥å‘Š

---

## ğŸ‰ æˆæœ

### Agent èƒ½åŠ›å‡çº§

**ä¹‹å‰:**
- âœ… åŸºç¡€å·¥å…·è°ƒç”¨ï¼ˆåˆ—è¡¨ã€æŸ¥è¯¢ï¼‰
- âœ… LangGraph çŠ¶æ€æœº
- âŒ RAG èƒ½åŠ›æœªé›†æˆ
- âŒ åœºæ™¯åˆ†æéœ€æ‰‹åŠ¨æ“ä½œ
- âŒ æ— æ„å›¾åŒºåˆ†

**ç°åœ¨:**
- âœ… **RAG è¯­ä¹‰æœç´¢**ï¼ˆæœ€é‡è¦çš„å‡çº§ï¼‰
- âœ… **ä¸€é”®åœºæ™¯åˆ†æ**ï¼ˆæ•´åˆ AI èƒ½åŠ›ï¼‰
- âœ… **æ™ºèƒ½æ„å›¾åˆ†ç±»**ï¼ˆQA vs Chatï¼‰
- âœ… **åŒæ¨¡å¼è·¯ç”±**ï¼ˆä¸åŒåœºæ™¯ä¸åŒç­–ç•¥ï¼‰
- âœ… **å¯æ‰©å±•æ¶æ„**ï¼ˆæ˜“äºæ·»åŠ æ–°å·¥å…·ï¼‰

### ç”¨æˆ·ä½“éªŒæå‡

**åœºæ™¯ 1: ä¸–ç•Œè§‚æŸ¥è¯¢**
```
ç”¨æˆ·: "è¿™ä¸ªä¸–ç•Œçš„èµ›åšæ”¹é€ æŠ€æœ¯è¾¾åˆ°ä»€ä¹ˆæ°´å¹³ï¼Ÿ"
ä¹‹å‰: Agent åªèƒ½æŸ¥æ‰¾åŒ…å«"èµ›åšæ”¹é€ "å…³é”®è¯çš„åœºæ™¯ï¼ˆå¯èƒ½æ‰¾ä¸åˆ°ï¼‰
ç°åœ¨: ä½¿ç”¨è¯­ä¹‰æœç´¢ï¼Œæ‰¾åˆ°æ‰€æœ‰ç›¸å…³æè¿°ï¼Œç»¼åˆå›ç­”
```

**åœºæ™¯ 2: åœºæ™¯å®¡æŸ¥**
```
ç”¨æˆ·: "å¸®æˆ‘çœ‹çœ‹ scene_05 æœ‰ä»€ä¹ˆé—®é¢˜"
ä¹‹å‰: éœ€è¦æ‰‹åŠ¨å» AI å·¥å…·é¢æ¿ï¼Œåˆ†åˆ«ç‚¹å‡»æ‘˜è¦ã€æå–è®¾å®šç­‰
ç°åœ¨: Agent ä¸€é”®è°ƒç”¨ analyze_sceneï¼Œè¿”å›å®Œæ•´æŠ¥å‘Š
```

**åœºæ™¯ 3: åˆ›æ„è®¨è®º**
```
ç”¨æˆ·: "æˆ‘è§‰å¾—è¿™ä¸ªè§’è‰²çš„åŠ¨æœºä¸å¤Ÿå¼º"
ä¹‹å‰: Agent å¯èƒ½ä¼šä¸€ç›´æŸ¥å·¥å…·ï¼Œæ²¡æœ‰çœŸæ­£çš„è®¨è®º
ç°åœ¨: è¯†åˆ«ä¸º chat æ¨¡å¼ï¼Œè¿›è¡Œå¼€æ”¾å¼è®¨è®ºï¼ŒæŒ‰éœ€æŸ¥è¯¢äº‹å®
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- LangGraph å®˜æ–¹æ–‡æ¡£: https://langchain-ai.github.io/langgraph/
- Tool Calling æœ€ä½³å®è·µ: https://sparkco.ai/blog/advanced-tool-calling-in-llm-agents
- RAG Agent æ¨¡å¼: https://medium.com/@karthikeyasuppa01/crafting-tales-with-ai-building-a-story-generator-using-rag-6aab06ba36fc
- LangGraph Supervisor æ¨¡å¼: https://www.swarnendu.de/blog/langgraph-best-practices/

---

**å®Œæˆæ—¶é—´:** 2025-12-29  
**ç‰ˆæœ¬:** v1.0 - Enhanced Agent Release
